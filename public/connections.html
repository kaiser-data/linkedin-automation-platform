<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Connections Manager - LinkedIn Connect</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f7fa;
      color: #333;
    }

    .header {
      background: white;
      padding: 20px 40px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      color: #0073b1;
      font-size: 24px;
    }

    .nav {
      display: flex;
      gap: 5px;
    }

    .nav a {
      text-decoration: none;
      color: #666;
      padding: 8px 16px;
      border-bottom: 3px solid transparent;
      font-weight: 500;
      transition: all 0.2s;
    }

    .nav a:hover {
      color: #0073b1;
      background: #f8f9fa;
    }

    .nav a.active {
      color: #0073b1;
      border-bottom-color: #0073b1;
    }

    .container {
      max-width: 1400px;
      margin: 40px auto;
      padding: 0 40px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 24px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .stat-card h3 {
      color: #666;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .stat-card .value {
      font-size: 32px;
      font-weight: 600;
      color: #0073b1;
    }

    .upload-section {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .upload-section h2 {
      margin-bottom: 20px;
      color: #333;
    }

    .upload-area {
      border: 2px dashed #0073b1;
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: background 0.2s;
    }

    .upload-area:hover {
      background: #f3f6f8;
    }

    .upload-area.drag-over {
      background: #e8f4f9;
      border-color: #0056b3;
    }

    .upload-instructions {
      margin-top: 20px;
      padding: 15px;
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      border-radius: 4px;
      text-align: left;
    }

    .upload-instructions h4 {
      margin-bottom: 10px;
      color: #856404;
    }

    .upload-instructions ol {
      margin-left: 20px;
      color: #856404;
    }

    .connections-section {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .search-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .search-bar input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .search-bar button {
      padding: 12px 24px;
      background: #0073b1;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }

    .search-bar button:hover {
      background: #005885;
    }

    .connections-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .connections-table th {
      background: #f8f9fa;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #666;
      border-bottom: 2px solid #ddd;
    }

    .connections-table td {
      padding: 12px;
      border-bottom: 1px solid #eee;
    }

    .connections-table tr:hover {
      background: #f8f9fa;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }

    .badge-success {
      background: #d4edda;
      color: #155724;
    }

    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }

    .btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: background 0.2s;
    }

    .btn-primary {
      background: #0073b1;
      color: white;
    }

    .btn-primary:hover {
      background: #005885;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .btn-sm {
      padding: 4px 8px;
      font-size: 12px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .empty-state svg {
      width: 80px;
      height: 80px;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    .alert {
      padding: 16px;
      border-radius: 4px;
      margin-bottom: 20px;
    }

    .alert-success {
      background: #d4edda;
      border-left: 4px solid #28a745;
      color: #155724;
    }

    .alert-error {
      background: #f8d7da;
      border-left: 4px solid #dc3545;
      color: #721c24;
    }

    .alert-info {
      background: #d1ecf1;
      border-left: 4px solid #17a2b8;
      color: #0c5460;
    }

    .file-input {
      display: none;
    }

    .pagination {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }

    .pagination button {
      padding: 8px 12px;
      border: 1px solid #ddd;
      background: white;
      cursor: pointer;
      border-radius: 4px;
    }

    .pagination button:hover:not(:disabled) {
      background: #f8f9fa;
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pagination button.active {
      background: #0073b1;
      color: white;
      border-color: #0073b1;
    }

    .pagination-info {
      text-align: center;
      color: #666;
      margin-top: 10px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üîó Connections Manager</h1>
    <div class="nav">
      <a href="/dashboard">üìä Dashboard</a>
      <a href="/connections" class="active">üîó Connections</a>
      <a href="/logout">Logout</a>
    </div>
  </div>

  <div class="container">
    <!-- Statistics -->
    <div class="stats-grid">
      <div class="stat-card">
        <h3>Total Connections</h3>
        <div class="value" id="totalConnections">-</div>
      </div>
      <div class="stat-card">
        <h3>With Profile Data</h3>
        <div class="value" id="withData">-</div>
      </div>
      <div class="stat-card">
        <h3>Needs Data</h3>
        <div class="value" id="withoutData">-</div>
      </div>
    </div>

    <!-- Upload Section -->
    <div class="upload-section">
      <h2>üì§ Import Connections</h2>

      <div id="uploadAlert"></div>

      <div class="upload-area" id="uploadArea">
        <input type="file" id="csvFile" class="file-input" accept=".csv" />
        <p style="font-size: 18px; margin-bottom: 10px;">üìÅ Drop your LinkedIn connections CSV here</p>
        <p style="color: #666; margin-bottom: 15px;">or click to browse</p>
        <button class="btn btn-primary" onclick="document.getElementById('csvFile').click()">Choose File</button>
      </div>

      <div class="upload-instructions">
        <h4>üìù How to export your LinkedIn connections:</h4>
        <ol>
          <li>Go to LinkedIn Settings & Privacy ‚Üí Data Privacy ‚Üí Get a copy of your data</li>
          <li>Select "Connections" and click "Request archive"</li>
          <li>Wait for email (usually within 10 minutes)</li>
          <li>Download and extract the ZIP file</li>
          <li>Upload the "Connections.csv" file here</li>
        </ol>
        <p style="margin-top: 10px;"><strong>Expected CSV format:</strong> First Name, Last Name, URL, Email Address, Company, Position, Connected On</p>
        <p style="margin-top: 5px; font-size: 13px;"><em>Note: Email addresses may be empty if connections haven't shared them in their privacy settings.</em></p>
      </div>
    </div>

    <!-- Connections List -->
    <div class="connections-section">
      <h2>üë• Your Connections</h2>

      <div class="search-bar">
        <select id="searchCategory" style="padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
          <option value="all">All Fields</option>
          <option value="name">Name</option>
          <option value="company">Company</option>
          <option value="position">Position</option>
          <option value="location">Location</option>
        </select>
        <input type="text" id="searchInput" placeholder="Search connections..." />
        <button onclick="searchConnections()">Search</button>
        <button class="btn-secondary" onclick="loadAllConnections(1)">Show All</button>
      </div>

      <div id="connectionsContent">
        <div class="loading">Loading connections...</div>
      </div>
    </div>
  </div>

  <script>
    let currentConnections = [];
    let currentPage = 1;
    let totalPages = 1;
    let totalConnections = 0;
    let totalSearchResults = 0;
    const perPage = 50;

    // Search state management
    let searchMode = false;
    let searchQuery = '';
    let searchCategory = 'all';

    // Load stats on page load
    async function loadStats() {
      try {
        const response = await fetch('/api/connections/stats');
        const stats = await response.json();

        totalConnections = stats.total || 0;
        document.getElementById('totalConnections').textContent = totalConnections;
        document.getElementById('withData').textContent = stats.with_data || 0;
        document.getElementById('withoutData').textContent = stats.without_data || 0;
      } catch (error) {
        console.error('Failed to load stats:', error);
      }
    }

    // Load all connections with pagination
    async function loadAllConnections(page = 1) {
      try {
        console.log('loadAllConnections called, page:', page);

        // Clear search mode
        searchMode = false;
        searchQuery = '';
        searchCategory = 'all';

        const offset = (page - 1) * perPage;
        console.log('Fetching connections with offset:', offset);

        const response = await fetch(`/api/connections?limit=${perPage}&offset=${offset}`);
        const connections = await response.json();

        console.log('Received', connections.length, 'connections');

        currentConnections = connections;
        currentPage = page;
        totalPages = Math.ceil(totalConnections / perPage);

        console.log('Rendering page', currentPage, 'of', totalPages);
        renderConnections(connections);
      } catch (error) {
        showError('Failed to load connections');
        console.error('Error loading connections:', error);
      }
    }

    // Search connections with pagination
    async function searchConnections(page = 1) {
      const query = document.getElementById('searchInput').value;
      const category = document.getElementById('searchCategory').value;

      console.log('searchConnections called, page:', page, 'query:', query, 'category:', category);

      if (!query.trim()) {
        loadAllConnections(1);
        return;
      }

      try {
        // Enable search mode and store search parameters
        searchMode = true;
        searchQuery = query;
        searchCategory = category;

        const offset = (page - 1) * perPage;
        console.log('Searching with offset:', offset);

        const response = await fetch(`/api/connections/search?q=${encodeURIComponent(query)}&category=${category}&limit=${perPage}&offset=${offset}`);
        const result = await response.json();

        console.log('Search returned', result.connections.length, 'connections, total:', result.total);

        currentConnections = result.connections;
        currentPage = page;
        totalSearchResults = result.total;
        totalPages = Math.ceil(result.total / perPage);

        console.log('Rendering search page', currentPage, 'of', totalPages);
        renderConnections(result.connections);
      } catch (error) {
        showError('Search failed');
        console.error('Search error:', error);
      }
    }

    // Navigate to a specific page (handles both search and all modes)
    function navigateToPage(page) {
      console.log('navigateToPage called with:', page, 'searchMode:', searchMode);

      // Show loading indicator
      const content = document.getElementById('connectionsContent');
      content.innerHTML = '<div class="loading">Loading...</div>';

      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });

      if (searchMode) {
        searchConnections(page);
      } else {
        loadAllConnections(page);
      }
    }

    // Expose to window for inline handlers
    window.goToPage = navigateToPage;

    // Render connections table
    function renderConnections(connections) {
      const content = document.getElementById('connectionsContent');

      if (connections.length === 0) {
        content.innerHTML = `
          <div class="empty-state">
            <svg fill="currentColor" viewBox="0 0 20 20">
              <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path>
            </svg>
            <h3>No connections found</h3>
            <p>Upload your LinkedIn connections CSV to get started</p>
          </div>
        `;
        return;
      }

      const startNum = (currentPage - 1) * perPage + 1;
      const endNum = Math.min(startNum + connections.length - 1, totalConnections);

      const tableHTML = `
        <table class="connections-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Location</th>
              <th>Company</th>
              <th>Position</th>
              <th>Connected On</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${connections.map(conn => {
              const hasUrl = conn.linkedin_profile_url && conn.linkedin_profile_url.trim() !== '';
              return `
              <tr>
                <td>
                  <strong>${conn.first_name} ${conn.last_name}</strong>
                  ${hasUrl ?
                    `<br><a href="${conn.linkedin_profile_url}" target="_blank" rel="noopener noreferrer" style="font-size: 12px; color: #0073b1; text-decoration: none;">
                      üîó LinkedIn Profile
                    </a>` : ''
                  }
                </td>
                <td>${conn.location || '-'}</td>
                <td>${conn.company || '-'}</td>
                <td>${conn.position || '-'}</td>
                <td>${conn.connected_on || '-'}</td>
                <td>
                  ${conn.profile_fetched ?
                    '<span class="badge badge-success">‚úì Has Data</span>' :
                    '<span class="badge badge-warning">‚ö† No Data</span>'
                  }
                </td>
                <td>
                  <button class="btn btn-sm btn-primary" onclick="window.viewConnection(${conn.id})">View</button>
                </td>
              </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;

      const totalCount = searchMode ? totalSearchResults : totalConnections;
      const paginationInfoHTML = `
        <div class="pagination-info">
          Showing ${startNum}-${endNum} of ${totalCount} ${searchMode ? 'results' : 'connections'}
        </div>
      `;

      const paginationHTML = renderPaginationHTML();

      content.innerHTML = tableHTML + paginationInfoHTML + paginationHTML;
    }

    // Render pagination controls HTML
    function renderPaginationHTML() {
      if (totalPages <= 1) return '';

      let html = '<div class="pagination" id="paginationControls">';

      // Previous button - using window.goToPage for reliability
      if (currentPage === 1) {
        html += `<button disabled>‚Üê Previous</button>`;
      } else {
        html += `<button onclick="window.goToPage(${currentPage - 1})">‚Üê Previous</button>`;
      }

      // Page numbers (show max 7 pages)
      const maxPages = 7;
      let startPage = Math.max(1, currentPage - Math.floor(maxPages / 2));
      let endPage = Math.min(totalPages, startPage + maxPages - 1);

      if (endPage - startPage < maxPages - 1) {
        startPage = Math.max(1, endPage - maxPages + 1);
      }

      if (startPage > 1) {
        html += `<button onclick="window.goToPage(1)">1</button>`;
        if (startPage > 2) html += `<button disabled>...</button>`;
      }

      for (let i = startPage; i <= endPage; i++) {
        html += `
          <button onclick="window.goToPage(${i})" class="${i === currentPage ? 'active' : ''}">
            ${i}
          </button>
        `;
      }

      if (endPage < totalPages) {
        if (endPage < totalPages - 1) html += `<button disabled>...</button>`;
        html += `<button onclick="window.goToPage(${totalPages})">${totalPages}</button>`;
      }

      // Next button
      if (currentPage === totalPages) {
        html += `<button disabled>Next ‚Üí</button>`;
      } else {
        html += `<button onclick="window.goToPage(${currentPage + 1})">Next ‚Üí</button>`;
      }

      html += '</div>';
      return html;
    }

    // View connection details (placeholder)
    function viewConnection(id) {
      console.log('viewConnection called for ID:', id);
      alert(`Connection details view coming soon! ID: ${id}\n\nYou'll be able to:\n- View profile data\n- Add tags\n- Add notes\n- Manually fetch profile data`);
    }

    // Expose to window for inline handlers
    window.viewConnection = viewConnection;

    // File upload handling
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('csvFile');

    uploadArea.addEventListener('click', () => fileInput.click());

    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('drag-over');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('drag-over');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('drag-over');

      const files = e.dataTransfer.files;
      if (files.length > 0) {
        fileInput.files = files;
        uploadCSV();
      }
    });

    fileInput.addEventListener('change', uploadCSV);

    // Upload CSV
    async function uploadCSV() {
      const file = fileInput.files[0];
      if (!file) return;

      if (!file.name.endsWith('.csv')) {
        showAlert('Please upload a CSV file', 'error');
        return;
      }

      const formData = new FormData();
      formData.append('csvFile', file);

      showAlert('Uploading and importing connections...', 'info');

      try {
        const response = await fetch('/api/connections/import', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        if (response.ok) {
          showAlert(result.message, 'success');
          loadStats();
          loadAllConnections();
          fileInput.value = '';
        } else {
          showAlert(result.error || 'Upload failed', 'error');
        }
      } catch (error) {
        showAlert('Upload failed: ' + error.message, 'error');
        console.error(error);
      }
    }

    // Show alert
    function showAlert(message, type) {
      const alertDiv = document.getElementById('uploadAlert');
      alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;

      if (type === 'success') {
        setTimeout(() => alertDiv.innerHTML = '', 5000);
      }
    }

    function showError(message) {
      showAlert(message, 'error');
    }

    // Search on Enter key
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        searchConnections();
      }
    });

    // Load data on page load
    async function init() {
      await loadStats();
      loadAllConnections(1);
    }

    init();
  </script>
</body>
</html>
